### **自动化框架关键字使用指南 (V1.04)**

#### **核心操作逻辑**

本框架采用**"活动页面 + 临时指定"**相结合的多页面操作模型：
*   **活动页面 (Active Page)**: 框架内部始终维护一个"当前活动页面"。所有未指定`页面`列的关键字，都在这个活动页面上执行。
*   **`switch_to_page`**: 这是**唯一**能改变"活动页面"的关键字。它像切换电视频道，效果是持久的。
*   **`页面`列**: 执行任何关键字时，框架都会优先检查此列。如果此列有值（如`1`, `2`），则该步骤**临时**在指定页面上执行，但**不改变**"活动页面"。

#### **智能页面管理**
框架实现了智能页面管理机制，确保多页面操作的稳定性和可靠性：
*   **智能等待**: 当请求一个尚未创建的页面时，框架会自动等待页面创建完成
*   **状态验证**: 在操作页面前，自动验证页面状态（可见性、加载状态、DOM就绪等）
*   **自动恢复**: 对于状态异常的页面，框架会尝试自动恢复（等待加载完成、重新加载等）
*   **容错处理**: 当页面不存在时，框架会使用最后可用页面作为替代，避免测试中断

#### **错误恢复机制**
框架具备强大的错误恢复能力，能够处理页面状态异常并自动恢复：
*   **页面状态检测**: 自动检测页面关闭、加载未完成等异常状态
*   **智能重试**: 对于失败的操作，框架会尝试恢复页面状态后重试
*   **作用域恢复**: 对于`expect_codegen`中的页面变量，框架能自动恢复缺失的页面引用
*   **详细日志**: 提供完整的错误信息和恢复过程日志，便于问题诊断

#### **无头模式行为**
框架在无头模式下具有特殊的行为优化：
*   **sleep自动跳过**: `sleep`关键字在无头模式下会自动跳过以提高执行效率
*   **智能等待优化**: 在无头模式下，框架会优化等待策略以适应更快的执行速度
*   **资源管理**: 无头模式下更严格地管理浏览器资源，避免内存泄漏

---

### **一、 页面/窗口操作**

#### 1. **open** - 打开页面
在**当前的活动页面**上导航到指定的URL，此操作会覆盖当前页面的内容。

*   **使用场景**: 开始测试的第一个步骤，或在当前标签页跳转到新地址。

| 编号       | 页面  | 关键字    | 验证类型 | 定位方式 | 目标对象 | 数据内容                        | 描述             |
| :------- | :-- | :----- | :--- | :--- | :--- | :-------------------------- | :------------- |
| case_001 |     | `open` |      |      |      | `http://www.baidu.com`      | 打开百度首页（使用默认超时） |
| case_002 |     | `open` |      |      |      | `http://www.taobao.com, 45` | 打开淘宝（自定义45秒超时） |

#### 2. **open_in_new_page** - 在新标签页打开
在新标签页中打开一个URL，并**自动将新页面设为活动页面**。

*   **使用场景**: 需要在一个独立、干净的页面环境中测试某个功能，同时不影响主页面。

| 编号       | 页面  | 关键字                | 验证类型 | 定位方式 | 目标对象 | 数据内容                    | 描述               |
| :------- | :-- | :----------------- | :--- | :--- | :--- | :---------------------- | :--------------- |
| case_003 |     | `open_in_new_page` |      |      |      | `https://map.baidu.com` | 在新标签页打开百度地图并切换焦点 |

#### 3. **switch_to_page** - 切换活动页面
切换框架的“活动页面”焦点。后续所有未指定`页面`列的操作将在此页面进行。

*   **使用场景**: 在多个已打开的标签页之间进行明确的状态切换。

| 编号       | 页面  | 关键字              | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述              |
| :------- | :-- | :--------------- | :--- | :--- | :--- | :--- | :-------------- |
| case_004 |     | `switch_to_page` |      |      |      | `1`  | 将主操作页面切换回第一个标签页 |

#### 4. **close_page** - 关闭页面
关闭指定的标签页。如果`数据内容`为空，则关闭当前活动页。

*   **使用场景**: 测试完一个子流程后，关闭其标签页，返回主流程。

| 编号       | 页面  | 关键字          | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述        |
| :------- | :-- | :----------- | :--- | :--- | :--- | :--- | :-------- |
| case_005 |     | `close_page` |      |      |      | `2`  | 关闭第二个标签页  |
| case_006 |     | `close_page` |      |      |      |      | 关闭当前的活动页面 |

#### 5. **go_back** / **go_forward** - 页面前进/后退
模拟浏览器的“后退”和“前进”按钮。

*   **使用场景**: 验证页面历史记录的导航功能是否正常。

| 编号       | 页面  | 关键字          | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述   |
| :------- | :-- | :----------- | :--- | :--- | :--- | :--- | :--- |
| case_007 |     | `go_back`    |      |      |      |      | 页面后退 |
| case_008 |     | `go_forward` |      |      |      |      | 页面前进 |

#### 6. **set_window_size** - 设置窗口大小
设置当前活动页面的浏览器视口大小。

*   **使用场景**: 模拟不同分辨率的设备，进行响应式布局测试。

| 编号       | 页面  | 关键字               | 验证类型 | 定位方式 | 目标对象 | 数据内容        | 描述             |
| :------- | :-- | :---------------- | :--- | :--- | :--- | :---------- | :------------- |
| case_009 |     | `set_window_size` |      |      |      | `1920x1080` | 设置为桌面分辨率       |
| case_010 |     | `set_window_size` |      |      |      | `375x812`   | 模拟iPhone X的分辨率 |

---

### **二、 核心元素交互**

#### 7. **click** - 点击元素
在找到的元素上执行单击操作。

*   **使用场景**: 点击按钮、链接、选项框等一切可交互元素。

| 编号       | 页面  | 关键字     | 验证类型 | 定位方式          | 目标对象                | 数据内容 | 描述                   |
| :------- | :-- | :------ | :--- | :------------ | :------------------ | :--- | :------------------- |
| case_011 |     | `click` |      | `get_by_role` | `button, name="提交"` |      | **（推荐）** 点击名为“提交”的按钮 |
| case_012 |     | `click` |      | `css`         | `#login-button`     |      | 点击ID为login-button的元素 |

#### 8. **on_input** - 输入文本
先清空输入框，然后填入指定的文本内容。

*   **使用场景**: 在所有文本输入框、搜索框中输入内容。

| 编号       | 页面  | 关键字        | 验证类型 | 定位方式                 | 目标对象         | 数据内容         | 描述                             |
| :------- | :-- | :--------- | :--- | :------------------- | :----------- | :----------- | :----------------------------- |
| case_013 |     | `on_input` |      | `get_by_placeholder` | `请输入您的用户名`   | `test_user`  | **（推荐）** 通过placeholder定位输入框并输入 |
| case_014 | `2` | `on_input` |      | `id`                 | `search-box` | `Playwright` | 在**页面2**的搜索框中输入                |

#### 9. **press** - 按下键盘
在指定的元素上模拟按下单个或组合键盘按键。

*   **使用场景**: 提交表单（Enter）、在选项间切换（Tab）、执行快捷键（Control+C）。

| 编号       | 页面  | 关键字     | 验证类型 | 定位方式  | 目标对象              | 数据内容    | 描述         |
| :------- | :-- | :------ | :--- | :---- | :---------------- | :------ | :--------- |
| case_015 |     | `press` |      | `css` | `input[name='q']` | `Enter` | 在搜索框内按下回车键 |

#### 10. **check** - 选中复选框/单选框
选中复选框或单选框元素，如果元素已经是选中状态，则不会重复选中。

*   **使用场景**: 选中表单中的复选框、单选框等可选择元素。
*   **增强功能**:
    *   智能等待 - 自动等待元素可见、可交互
    *   状态检测 - 自动检测元素是否已选中，避免重复操作
    *   多定位器支持 - 支持所有框架提供的定位方式（css、get_by_role、codegen等）

| 编号       | 页面  | 关键字    | 验证类型 | 定位方式          | 目标对象                    | 数据内容 | 描述                       |
| :------- | :-- | :----- | :--- | :------------ | :-------------------- | :--- | :----------------------- |
| case_016 |     | `check` |      | `get_by_role` | `checkbox, name="记住我"` |      | **（推荐）** 选中"记住我"复选框 |
| case_017 |     | `check` |      | `css`         | `#terms-checkbox`     |      | 选中ID为terms-checkbox的复选框 |
| case_018 |     | `check` |      | `get_by_label`| `同意用户协议`          |      | 通过label选中"同意用户协议"复选框 |
| case_019 |     | `check` |      | `get_by_role` | `radio, name="男"`     |      | 选中"男"单选框              |
| case_020 | `2` | `check` |      | `codegen`     | `page.locator("input[name='newsletter']")` |      | 在**页面2**使用codegen定位器选中复选框 |

#### 11. **clear_input** - 清空输入
清空指定的输入框内容。

*   **使用场景**: `on_input`已自带清空，此关键字仅用于需要单独执行"清空"动作的特殊场景。

| 编号       | 页面  | 关键字           | 验证类型 | 定位方式 | 目标对象           | 数据内容 | 描述          |
| :------- | :-- | :------------ | :--- | :--- | :------------- | :--- | :---------- |
| case_021 |     | `clear_input` |      | `id` | `comment-area` |      | 清空评论区已输入的内容 |

#### 12. **upload_file** - 上传文件
将本地文件“上传”到页面，无需与操作系统原生窗口交互。

- **使用场景**: 测试所有包含文件上传功能的场景。

| 编号       | 页面  | 关键字           | 验证类型 | 定位方式  | 目标对象                 | 数据内容                   | 描述     |
| -------- | --- | ------------- | ---- | ----- | -------------------- | ---------------------- | ------ |
| case_017 |     | `upload_file` |      | `css` | `input[type='file']` | `test_data/avatar.jpg` | 上传头像图片 |

---
---

### **三、 高级交互**

#### 13. **hover** - 鼠标悬停
将鼠标指针悬停在指定的元素上。

*   **使用场景**: 触发需要鼠标悬停才能出现的二级菜单、提示信息（Tooltip）等。

| 编号 | 页面 | 关键字 | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述 |
|:--- |:--- |:--- |:--- |:--- |:--- |:--- |:--- |
| case_017 | | `hover`| | `get_by_text` |`我的账户` | | 悬停在“我的账户”菜单上 |

#### 14. **scroll_page** - 滚动页面
在当前活动页面上模拟鼠标滚轮滚动。

*   **使用场景**: 测试懒加载页面，或需要滚动到页面特定区域才能看到的元素。

| 编号 | 页面 | 关键字 | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述 |
|:--- |:--- |:--- |:--- |:--- |:--- |:--- |:--- |
| case_018 | | `scroll_page`| | | | `0,2000` | 向下滚动2000像素 |
| case_019 | | `scroll_page`| | | | `0,-500`| 向上滚动500像素 |

#### 15. **drag_and_drop** - 拖拽元素
将一个源元素拖拽到另一个目标元素上。
*   **使用场景**: 测试滑块、看板（Trello）、自定义布局等拖拽功能。
*   **参数说明**:
    *   **目标对象/定位方式**: 描述的是【源元素】
    *   **数据内容**: 描述的是【目标元素】的CSS选择器或XPath
*   **增强功能**:
    *   智能元素定位 - 自动定位源元素和目标元素
    *   稳定拖拽操作 - 使用Playwright的drag_to方法确保拖拽操作的稳定性

*   **使用场景**: 测试滑块、看板（Trello）、自定义布局等拖拽功能。

| 编号 | 页面 | 关键字 | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述 |
|:--- |:--- |:--- |:--- |:--- |:--- |:--- |:--- |
| case_020 | | `drag_and_drop`| `id` | `draggable-item-3` | `#drop-target-area` | 将ID为...的元素拖到目标区域 |

#### 16. **click_at_position** - 定点点击
在元素的相对位置或页面的绝对坐标上执行点击。
*   **使用场景**: 点击进度条、Canvas图表、或页面上无明显定位特征的固定区域。
*   **参数说明**:
    *   **相对位置模式**: 提供定位方式和目标对象时，数据内容使用 "x=0.5, y=0.5" 格式（相对坐标，0.5代表中心点）
    *   **绝对坐标模式**: 不提供定位方式和目标对象时，数据内容使用 "x=800, y=600" 格式（绝对视口坐标）
*   **增强功能**:
    *   精确定位 - 支持相对位置和绝对坐标两种模式
    *   智能模式识别 - 自动识别相对位置模式还是绝对坐标模式
    *   稳定点击操作 - 使用Playwright的click方法确保点击操作的稳定性

*   **使用场景**: 点击进度条、Canvas图表、或页面上无明显定位特征的固定区域。

| 编号 | 页面 | 关键字 | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述 |
|:--- |:--- |:--- |:--- |:--- |:--- |:--- |:--- |
| case_021 | | `click_at_position`| `css` | `.video-progress` | `x=0.9, y=0.5` | 点击视频进度条90%处 |
| case_022 | | `click_at_position`| | | | `x=100, y=200` | 点击视口(100,200)的绝对坐标 |

---

### **四、 验证与断言**

#### 17. **verify** - 通用验证
框架的核心验证关键字，用于断言页面状态或元素属性是否符合预期。
*   **使用场景**: 检查元素是否可见、文本是否正确、URL是否跳转成功等。
*   **验证类型**:
    *   `element_visible` - 验证元素是否可见
    *   `element_text_equals` - 验证元素文本是否完全匹配
    *   `element_text_contains` - 验证元素文本是否包含指定内容
    *   `url_contains` - 验证当前URL是否包含指定路径
*   **增强功能**:
    *   智能等待 - 自动等待元素出现再进行验证
    *   详细错误信息 - 提供清晰的验证失败原因

*   **使用场景**: 检查元素是否可见、文本是否正确、URL是否跳转成功等。

| 编号 | 页面 | 关键字 | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述 |
|:--- |:--- |:--- |:--- |:--- |:--- |:--- |:--- |
| case_023 | | `verify`| `element_visible`| `get_by_role` | `alert, name="成功"` | | 验证：“成功”提示框可见 |
| case_024 | | `verify`| `element_text_equals`| `css` | `h1.main-title`| `欢迎使用本系统`| 验证：H1标题文本完全匹配 |
| case_025 | | `verify`| `element_text_contains`| **`chain`** | `div#user-card >> span.level` | `高级会员` | **(高级)** 验证用户卡片内的等级包含文本 |
| case_026 | | `verify`| `url_contains`| | | `/user/profile`| 验证：当前URL包含特定路径 |

#### 18. **expect_codegen** - Codegen断言
执行一个完整的、从Playwright Inspector复制的`expect(...)`断言表达式，提供了极高的灵活性。
*   **使用场景**: 处理标准`verify`关键字无法覆盖的复杂断言，如元素数量、CSS属性、ARIA角色等。
*   **可用变量**: page, pages (页面列表), page0, page1, page2, ... (页面对象), expect, re
*   **增强功能**:
    *   智能页面变量映射 - 自动检测和处理不存在的页面变量
    *   表达式预解析 - 提取和验证页面变量引用
    *   错误恢复机制 - 针对页面状态异常的智能处理
    *   详细日志 - 提供完整的执行过程和错误信息

*   **使用场景**: 处理标准`verify`关键字无法覆盖的复杂断言，如元素数量、CSS属性、ARIA角色等。

| 编号 | 页面 | 关键字 | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述 |
|:--- |:--- |:--- |:--- |:--- |:--- |:--- |:--- |
| case_027 | | `expect_codegen`| | | `expect(page.get_by_role("listitem")).to_have_count(10)` | | **(终极)** 验证列表项恰好有10个 |
| case_028 | | `expect_codegen`| | | `expect(pages[1].locator("h1")).to_have_css("color", "rgb(255, 0, 0)")`| | 验证**页面2**的H1标题是红色的 |
| case_029 | | `expect_codegen`| | | `expect(page1.get_by_text("欢迎")).to_be_visible()` | | 验证页面1中包含"欢迎"文本的元素可见 |
| case_037 | | `expect_codegen`| | | `expect(page.get_by_role("button", name=re.compile(r"提交.*"))).to_be_enabled()` | | 验证页面中包含"提交"的按钮是启用状态 |

---

### **五、 流程控制与工具**

#### 19. **sleep** - 强制等待
让程序暂停指定的秒数。**注意：在无头模式下会自动跳过以提高执行效率。**

*   **使用场景**: 仅用于调试，或等待某些无法用智能等待捕捉的后端处理。**请极力避免使用。**

| 编号 | 页面 | 关键字 | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述 |
|:--- |:--- |:--- |:--- |:--- |:--- |:--- |:--- |
| case_036 | | `sleep` | | | | `1.5` | **(不推荐)** 强制等待1.5秒 |

#### 20. **wait_until** - 等待元素可见
显式等待，直到某个元素出现在DOM中并变得可见。

*   **使用场景**: 等待由JS动态加载、但后续不直接对其进行`click`或`on_input`操作的元素。

| 编号 | 页面 | 关键字 | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述 |
|:--- |:--- |:--- |:--- |:--- |:--- |:--- |:--- |
| case_030 | | `wait_until`| | `id` |`loading-spinner-overlay` | | 等待加载动画出现(再等它消失) |

#### 21. **screenshot** - 截图
对指定或当前活动页面进行全屏截图。
*   **使用场景**: 在关键步骤或断言前后保存页面状态，用于人工核对或报告归档。
*   **参数说明**:
    *   **页面**: 可指定在哪个页面上进行截图操作
    *   **数据内容**: 截图保存的路径和文件名 (e.g., "reports/screenshots/login_success.png")
*   **增强功能**:
    *   全屏截图 - 自动截取整个页面的完整内容
    *   智能路径处理 - 自动创建不存在的目录结构
    *   多页面支持 - 可以在任意指定页面上进行截图

#### 22. **diagnose_page_issues** - 诊断页面问题
诊断和报告当前多页面状态问题，用于调试和排查多页面断言失败问题。
*   **使用场景**: 当遇到页面状态异常、多页面断言失败或需要调试多页面管理问题时使用。
*   **数据内容**:
    *   `basic` - 基本信息诊断（默认）
    *   `detailed` - 详细状态诊断
    *   `variables` - 变量作用域诊断
*   **增强功能**:
    *   智能页面状态检测 - 自动检测页面关闭、加载状态等问题
    *   变量作用域模拟 - 模拟`expect_codegen`中的变量可用性
    *   常见问题检查 - 自动检查页面关闭、JavaScript不可用等问题

*   **使用场景**: 在关键步骤或断言前后保存页面状态，用于人工核对或报告归档。

| 编号 | 页面 | 关键字 | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述 |
|:--- |:--- |:--- |:--- |:--- |:--- |:--- |:--- |
| case_037 | `2` | `screenshot`| | | | `reports/evidence/page2_state.png`| 对**页面2**进行截图并保存到指定路径 |
| case_038 | | `screenshot`| | | | `final_result.png`| 对当前活动页截图 |

| 编号 | 页面 | 关键字 | 验证类型 | 定位方式 | 目标对象 | 数据内容 | 描述 |
|:--- |:--- |:--- |:--- |:--- |:--- |:--- |:--- |
| case_039 | | `diagnose_page_issues`| | | | `basic` | 基本页面状态诊断 |
| case_040 | | `diagnose_page_issues`| | | | `detailed` | 详细页面状态诊断 |
| case_041 | | `diagnose_page_issues`| | | | `variables` | 变量作用域诊断 |

---

### **版本更新记录**

*   **V1.04** (2025-09-03):
    *   新增 `check` 关键字，用于选中复选框和单选框
    *   支持 `check` 关键字与codegen2excel工具的集成
    *   更新了关键字编号，确保连续性
    *   优化了关键字说明文档结构

*   **V1.03** (之前版本):
    *   完善了多页面操作和错误恢复机制
    *   增加了智能页面管理功能说明
    *   添加了无头模式行为说明
